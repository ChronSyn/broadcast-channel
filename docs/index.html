<html>

<head>
    <script src="./broadcast-channel.browserify.js"></script>
    <style>
        .msg-box {
            background-color: white;
            width: 400px;
            float: left;
            height: 500px;
            overflow-y: scroll;
        }

        #right {
            float: right;
            background-color: white;
            width: 300px;
            min-height: 200px;
            padding: 10px;
        }
    </style>
</head>

<body id="body">
    <iframe id="test-iframe" class="msg-box"></iframe>
    <div id="messages" class="msg-box"></div>

    <div id="right">
        <h2>BroadcastChannel live test</h2>
        <h4>(If this screen goes green, everything works)</h4>
        <p>This will send a message from the main-context, await until the iframe and the web-worker answered, then repeat until all messages have been send.</p>
        <b>User-Agent:</b> <span id="user-agent">unknown</span><br />
        <b>Method:</b> <span id="method">X</span><br />
        <b>MessageCount:</b> <span id="msg-count">0</span><br />
        <b>Amount Time:</b> <span id="time-amount">X</span><br />
        <b>State:</b> <b><span id="state">Running</span></b><br />
        <br/>
        <p>This is kirby, which stucks if the process is blocked</p>
        <img src="kirby.gif" />
    </div>
</body>


<script>
    // https://stackoverflow.com/a/901144/3443137
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    var methodType = getParameterByName('methodType');
    if (!methodType || methodType === '') methodType = undefined;

    var TEST_MESSAGES = 100;
    var body = document.getElementById('body');
    var msgContainer = document.getElementById('messages');
    var rightContainer = document.getElementById('right');
    var messageCountContainer = document.getElementById('msg-count');
    var stateContainer = document.getElementById('state');
    const iframeEl = document.getElementById('test-iframe');

    document.getElementById('user-agent').innerHTML = navigator.userAgent;

    var startTime = new Date().getTime();
    const options = {};
    var channel = new window.BroadcastChannel2('foobar', {
        type: methodType
    });
    document.getElementById('method').innerHTML = channel.type;

    /**
     * to measure the speed, we:
     * 1. send message
     * 2. wait until iframe and worker answers
     * 3. repeat from 1. for TEST_MESSAGES times
     */
    var messagesSend = 0;
    var answerPool = {};
    channel.onmessage = function(msg) {
        console.log('main: recieved msg' + JSON.stringify(msg));

        answerPool[msg.from] = msg;
        var textnode = document.createTextNode(JSON.stringify(msg) + '</br>');
        msgContainer.appendChild(textnode);

        if (answerPool.worker && answerPool.iframe) {
            answerPool = {}; // reset

            if (messagesSend >= TEST_MESSAGES) {
                // sucess
                console.log('main: sucess');
                body.style.backgroundColor = 'green';
                stateContainer.innerHTML = 'SUCCESS'
                const amountTime = new Date().getTime() - startTime;
                document.getElementById('time-amount').innerHTML = amountTime + 'ms';
            } else {
                // send next message
                messagesSend++;
                console.log('main: send next message (' + messagesSend + ') ====================');
                messageCountContainer.innerHTML = messagesSend;
                channel.postMessage({
                    from: 'main',
                    foo: 'bar',
                    step: messagesSend
                });
            }
        }
    };

    // set iframe src
    iframeEl.src = './iframe.html?channelName=' + channel.name + '&methodType=' + channel.type;

    // w8 until iframe has loaded
    iframeEl.onload = function() {
        console.log('main: Iframe has loaded');
        // spawn web-worker
        var worker = new Worker('worker.js');
        worker.onerror = function(event) {
            throw new Error('worker: ' + event.message + " (" + event.filename + ":" + event.lineno + ")");
        };

        worker.addEventListener('message', function(e) {
            // run when message returned, so we know the worker has started
            console.log('main: Worker has started');

            console.log('========== START SENDING MESSAGES ' + channel.type);
            channel.postMessage({
                from: 'main',
                step: 0
            });
            console.log('main: message send (0)');
        }, false);
        worker.postMessage({
            'cmd': 'start',
            'msg': {
                channelName: channel.name,
                methodType: channel.type
            }
        });
    }
</script>

</html>
